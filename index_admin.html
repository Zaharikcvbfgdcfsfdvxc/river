<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>RiverDub Admin</title>
    <link rel="icon" type="image/png" href="img/logo.png">
    <link rel="stylesheet" href="style.css">
</head>
<body>
<header class="top-bar">
     <a href="index.html" class="logo">
        <img src="img/logo.png" alt="Логотип RiverDub">
        <span>RiverDub</span>
    </a>

    <form class="search">
        <input type="text" placeholder="Поиск видео" aria-label="Поиск">
        <button type="submit">Найти</button>
    </form>

    <nav class="nav">
        <a href="index.html">Главная</a>
        <a href="index_videos.html">Видео</a>
        <a href="index_player.html">Плеер</a>
        <button class="ghost logout-button" type="button" id="logout-button">Выйти</button>
    </nav>
</header>

<main class="page admin-page">
    <div class="admin-auth" id="admin-auth">
        <div class="admin-auth-card">
            <button class="admin-auth-close" type="button" id="auth-close" aria-label="Закрыть">×</button>
            <p class="eyebrow">Доступ</p>
            <h2>Вход в админ-панель</h2>
            <p class="admin-lead">Добавляйте релизы озвучки для аудитории и демо-ролики, настраивайте тип и момент появления кнопки следующего ролика.</p>
            <form class="admin-form" id="admin-login">
                <label>
                    Логин
                    <input type="text" name="login" autocomplete="username" required>
                </label>
                <label>
                    Пароль
                    <input type="password" name="password" autocomplete="current-password" required>
                </label>
                <button class="primary" type="submit">Войти</button>
                <p class="admin-note" id="auth-error"></p>
            </form>
        </div>
    </div>
    <section class="admin-hero">
        <div>
            <p class="eyebrow">Админ</p>
            <h1>Загрузка работ студии</h1>
            <p class="admin-lead">Добавляйте релизы озвучки для аудитории и демо-ролики, настраивайте тип и момент появления кнопки следующего ролика.</p>
        </div>
        <div class="admin-stats">
            <div class="stat-card">
                <span class="stat-value" id="stored-count">0</span>
                <span class="stat-label">в очереди</span>
            </div>
            <div class="stat-card">
                <span class="stat-value" id="next-threshold">90%</span>
                <span class="stat-label">порог кнопки</span>
            </div>
        </div>
    </section>

    <section class="admin-grid">
        <div class="admin-card">
            <h2>Новый ролик</h2>
            <div class="admin-alert danger">
                <strong>Важно:</strong> называйте видео по шаблону «Название — сезон — серия», например:
                «Город света — 1 сезон — 3 серия».
            </div>
            <form class="admin-form" id="upload-form">
                <input type="hidden" name="video_id" id="video-id">
                <label>
                    Название
                    <input type="text" name="title" placeholder="Например: Линия горизонта" required>
                </label>
                <label>
                    Тип видео
                    <select name="type" required>
                        <option value="video">Видео</option>
                        <option value="demo">Демо-ролик</option>
                        <option value="background">Фоновое видео</option>
                    </select>
                </label>
                <label>
                    Описание
                    <textarea name="description" placeholder="Короткое описание"></textarea>
                </label>
                <div class="form-row">
                    <label>
                        Сезон
                        <input type="number" name="season" min="1" placeholder="1">
                    </label>
                    <label>
                        Серия
                        <input type="number" name="episode" min="1" placeholder="1">
                    </label>
                </div>
                <label>
                    Файл видео
                    <input type="file" name="file" accept="video/*">
                </label>
                <label>
                    Превью (обложка)
                    <input type="file" name="preview" accept="image/*">
                </label>
                <p class="admin-note">Если превью не выбрано, оно создастся автоматически из видео.</p>
                <label>
                    Порог кнопки «Следующая серия»
                    <input type="range" name="threshold" min="60" max="99" value="90">
                    <span class="range-value" id="threshold-value">90%</span>
                </label>
                <div class="admin-actions">
                    <button class="primary" type="submit" id="submit-button">
                        <span id="submit-label">Добавить видео</span>
                        <span class="spinner" aria-hidden="true"></span>
                    </button>
                    <button class="ghost" type="button" id="cancel-edit">Отмена</button>
                </div>
                <p class="admin-note">Видео сохраняются на сервере и появляются в библиотеке.</p>
                <p class="admin-note" id="upload-error"></p>
            </form>
        </div>

        <aside class="admin-card">
            <h2>Очередь загрузки</h2>
            <div class="queue-list" id="queue-list">
                <p class="contact-meta">Пока пусто.</p>
            </div>
        </aside>
    </section>

    <section class="admin-grid admin-settings">
        <div class="admin-card">
            <h2>Фон сайта</h2>
            <p class="admin-lead">Настройте видео-фон: включение и силу размытия.</p>
            <div class="admin-form" id="bg-settings">
                <label class="bg-toggle">
                    <input type="checkbox" id="bg-enabled">
                    <span class="bg-toggle-track"></span>
                    <span class="bg-toggle-text">Видео-фон включён</span>
                </label>
                <label>
                    Сила размытия
                    <input type="range" id="bg-blur" min="0" max="32" value="18">
                    <span class="range-value" id="bg-blur-value">18px</span>
                </label>
                <p class="admin-note" id="bg-status"></p>
            </div>
        </div>
    </section>
</main>

<footer class="footer">
    <p>(c) RiverDub Studio, 2024. Все права защищены.</p>
</footer>

<script>
    (function () {
        const authOverlay = document.getElementById('admin-auth');
        const loginForm = document.getElementById('admin-login');
        const authError = document.getElementById('auth-error');
        const logoutButton = document.getElementById('logout-button');
        const authClose = document.getElementById('auth-close');

        const unlock = () => {
            authOverlay.classList.add('hidden');
            document.body.classList.remove('locked');
        };

        const lock = () => {
            authOverlay.classList.remove('hidden');
            document.body.classList.add('locked');
        };

        if (authClose) {
            authClose.addEventListener('click', () => {
                authOverlay.classList.add('hidden');
                document.body.classList.remove('locked');
            });
        }

        authOverlay.addEventListener('click', (event) => {
            if (event.target === authOverlay) {
                authOverlay.classList.add('hidden');
                document.body.classList.remove('locked');
            }
        });

        fetch('/api/me')
            .then((res) => (res.ok ? unlock() : lock()))
            .catch(lock);

        loginForm.addEventListener('submit', (event) => {
            event.preventDefault();
            authError.textContent = '';
            const data = new FormData(loginForm);
            const login = String(data.get('login') || '').trim();
            const password = String(data.get('password') || '').trim();
            fetch('/api/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ login, password })
            })
                .then((res) => {
                    if (!res.ok) {
                        throw new Error('invalid');
                    }
                    unlock();
                    loginForm.reset();
                })
                .catch(() => {
                    authError.textContent = 'Неверный логин или пароль.';
                });
        });

        const form = document.getElementById('upload-form');
        const videoIdInput = document.getElementById('video-id');
        const submitButton = document.getElementById('submit-button');
        const submitLabel = document.getElementById('submit-label');
        const cancelEditButton = document.getElementById('cancel-edit');
        const uploadError = document.getElementById('upload-error');
        const fileInput = form.querySelector('input[name="file"]');
        const previewInput = form.querySelector('input[name="preview"]');
        const queueList = document.getElementById('queue-list');
        const thresholdValue = document.getElementById('threshold-value');
        const storedCount = document.getElementById('stored-count');
        const nextThreshold = document.getElementById('next-threshold');
        const thresholdInput = form.querySelector('input[name="threshold"]');
        const bgEnabledInput = document.getElementById('bg-enabled');
        const bgBlurInput = document.getElementById('bg-blur');
        const bgBlurValue = document.getElementById('bg-blur-value');
        const bgStatus = document.getElementById('bg-status');

        const typeMap = {
            video: 'Видео',
            demo: 'Демо-ролик',
            background: 'Фоновое видео'
        };

        const setSubmitLabel = (text) => {
            if (submitLabel) {
                submitLabel.textContent = text;
            } else {
                submitButton.textContent = text;
            }
        };

        const setUploading = (state) => {
            submitButton.classList.toggle('is-loading', state);
            submitButton.disabled = state;
        };

        const updateBlurLabel = () => {
            if (bgBlurInput && bgBlurValue) {
                bgBlurValue.textContent = `${bgBlurInput.value}px`;
            }
        };

        const loadBackgroundSettings = () => {
            if (!bgEnabledInput || !bgBlurInput) return;
            fetch('/api/settings/background')
                .then((res) => res.ok ? res.json() : null)
                .then((data) => {
                    if (!data) return;
                    bgEnabledInput.checked = data.enabled !== false;
                    bgBlurInput.value = Number.isFinite(Number(data.blur)) ? Number(data.blur) : 18;
                    updateBlurLabel();
                });
        };

        let bgSaveTimer;
        const saveBackgroundSettings = () => {
            if (!bgEnabledInput || !bgBlurInput) return;
            bgStatus.textContent = 'Сохраняем...';
            const payload = {
                enabled: bgEnabledInput.checked,
                blur: Number(bgBlurInput.value)
            };
            fetch('/api/settings/background', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
                .then((res) => res.ok ? res.json() : null)
                .then((data) => {
                    if (!data) {
                        bgStatus.textContent = 'Не удалось сохранить настройки.';
                        return;
                    }
                    bgStatus.textContent = 'Настройки сохранены.';
                })
                .catch(() => {
                    bgStatus.textContent = 'Ошибка сохранения.';
                });
        };

        const scheduleBackgroundSave = () => {
            clearTimeout(bgSaveTimer);
            bgSaveTimer = setTimeout(saveBackgroundSettings, 300);
        };

        const renderQueue = (items) => {
            storedCount.textContent = items.length;
            if (!items.length) {
                queueList.innerHTML = '<p class="contact-meta">Пока пусто.</p>';
                return;
            }
            queueList.innerHTML = '';
            items.forEach((item) => {
                const card = document.createElement('div');
                card.className = 'queue-card';
                const seasonLabel = item.season && item.episode ? `Сезон ${item.season} • Серия ${item.episode} • ` : '';
                card.innerHTML = `
                    <div>
                        <h4>${item.title}</h4>
                        <p class="player-meta">${typeMap[item.type] || 'Видео'} • ${seasonLabel}Порог ${item.threshold}%</p>
                        <p class="contact-meta">${item.description || 'Без описания'}</p>
                    </div>
                    <div class="queue-actions">
                        <button class="ghost" data-edit="${item.id}" type="button">Редактировать</button>
                        <button class="ghost danger" data-delete="${item.id}" type="button">Удалить</button>
                    </div>
                `;
                queueList.appendChild(card);
            });
        };

        const updateThresholdLabel = () => {
            thresholdValue.textContent = `${thresholdInput.value}%`;
            nextThreshold.textContent = `${thresholdInput.value}%`;
        };

        thresholdInput.addEventListener('input', updateThresholdLabel);
        updateThresholdLabel();
        fileInput.required = true;
        const loadList = () => {
            fetch('/api/videos')
                .then((res) => res.ok ? res.json() : [])
                .then((items) => renderQueue(items));
        };
        loadList();
        loadBackgroundSettings();

        if (bgBlurInput) {
            bgBlurInput.addEventListener('input', () => {
                updateBlurLabel();
                scheduleBackgroundSave();
            });
        }

        if (bgEnabledInput) {
            bgEnabledInput.addEventListener('change', scheduleBackgroundSave);
        }

        const setEditMode = (item) => {
            videoIdInput.value = item.id;
            form.title.value = item.title;
            form.type.value = typeMap[item.type] ? item.type : 'video';
            form.description.value = item.description || '';
            form.season.value = item.season || '';
            form.episode.value = item.episode || '';
            thresholdInput.value = item.threshold || 90;
            updateThresholdLabel();
            setSubmitLabel('Сохранить изменения');
            fileInput.required = false;
        };

        const resetForm = () => {
            form.reset();
            videoIdInput.value = '';
            setSubmitLabel('Добавить видео');
            thresholdInput.value = 90;
            updateThresholdLabel();
            fileInput.required = true;
            form.season.value = '';
            form.episode.value = '';
        };

        cancelEditButton.addEventListener('click', resetForm);

        const generatePreview = (file) => {
            if (!file || previewInput.files.length) return;
            const url = URL.createObjectURL(file);
            const video = document.createElement('video');
            video.preload = 'metadata';
            video.muted = true;
            video.src = url;
            video.addEventListener('loadedmetadata', () => {
                const targetTime = Math.min(2, video.duration * 0.1);
                video.currentTime = Number.isFinite(targetTime) ? targetTime : 0;
            });
            video.addEventListener('seeked', () => {
                const canvas = document.createElement('canvas');
                const width = 640;
                const ratio = video.videoWidth ? video.videoHeight / video.videoWidth : 0.5625;
                canvas.width = width;
                canvas.height = Math.round(width * ratio);
                const ctx = canvas.getContext('2d');
                if (!ctx) return;
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                canvas.toBlob((blob) => {
                    if (!blob) return;
                    const previewFile = new File([blob], 'preview.jpg', { type: 'image/jpeg' });
                    const dt = new DataTransfer();
                    dt.items.add(previewFile);
                    previewInput.files = dt.files;
                    URL.revokeObjectURL(url);
                }, 'image/jpeg', 0.85);
            });
        };

        fileInput.addEventListener('change', () => {
            const file = fileInput.files[0];
            generatePreview(file);
        });

        form.addEventListener('submit', (event) => {
            event.preventDefault();
            setUploading(true);
            const data = new FormData(form);
            const id = videoIdInput.value;
            const url = id ? `/api/videos/${id}` : '/api/videos';
            const method = id ? 'PUT' : 'POST';
            if (id) {
                data.delete('file');
                const fileInput = form.querySelector('input[name="file"]');
                if (fileInput && fileInput.files.length) {
                    data.set('file', fileInput.files[0]);
                }
            }
            fetch(url, { method, body: data })
                .then((res) => res.ok ? res.json() : null)
                .then((result) => {
                    if (!result) {
                        uploadError.textContent = 'Не удалось загрузить видео.';
                        return;
                    }
                    uploadError.textContent = '';
                    resetForm();
                    loadList();
                })
                .catch(() => {
                    uploadError.textContent = 'Ошибка загрузки. Проверьте сервер.';
                })
                .finally(() => {
                    setUploading(false);
                });
        });

        queueList.addEventListener('click', (event) => {
            const editButton = event.target.closest('[data-edit]');
            if (!editButton) return;
            const id = editButton.dataset.edit;
            fetch(`/api/videos/${id}`)
                .then((res) => res.ok ? res.json() : null)
                .then((item) => {
                    if (!item) return;
                    setEditMode(item);
                });
        });

        queueList.addEventListener('click', (event) => {
            const deleteButton = event.target.closest('[data-delete]');
            if (!deleteButton) return;
            const id = deleteButton.dataset.delete;
            if (!confirm('Удалить видео?')) return;
            fetch(`/api/videos/${id}`, { method: 'DELETE' })
                .then((res) => res.ok ? res.json() : null)
                .then((result) => {
                    if (!result) return;
                    loadList();
                });
        });

        logoutButton.addEventListener('click', () => {
            fetch('/api/logout', { method: 'POST' })
                .finally(() => lock());
        });
    })();
</script>
<script src="script.js"></script>
</body>
</html>

