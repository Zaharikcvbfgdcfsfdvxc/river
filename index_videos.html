<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RiverDub</title>
    <link rel="icon" type="image/png" href="img/logo.png">
    <link rel="stylesheet" href="style.css">
</head>
<body>
<header class="top-bar">
     <a href="index.html" class="logo">
        <img src="img/logo.png" alt="Логотип RiverDub">
        <span>RiverDub</span>
    </a>

    <form class="search">
        <input type="text" placeholder="Поиск видео" aria-label="Поиск">
        <button type="submit">Найти</button>
    </form>

    <nav class="nav">
        <a href="index.html">Главная</a>
        <a href="index_info.html">О нас</a>
        <a href="index_contacts.html">Контакты</a>
    </nav>
</header>

<main class="page videos-page">
    <section class="videos-hero" id="all">
        <div>
            <p class="eyebrow">Библиотека</p>
            <h1>Все работы RiverDub</h1>
            <p class="videos-lead">Подборка наших релизов озвучки и дубляжа для аудитории: видео и демо-ролики.</p>
        </div>
    </section>

    <section class="filter-bar">
        <a class="chip" href="#all">Все</a>
        <a class="chip" href="#videos">Видео</a>
        <a class="chip" href="#demo">Демо-ролики</a>
    </section>

    <div class="season-filter">
        <label for="season-select">Сезон</label>
        <select id="season-select">
            <option value="">Все сезоны</option>
        </select>
    </div>

    <section class="section" id="videos">
        <div class="section-header">
            <h2>Видео</h2>
            <a href="#all">Наверх</a>
        </div>
        <div class="video-grid" id="videos-grid"></div>
        <p class="empty-state" id="videos-empty">Пока нет видео.</p>
    </section>

    <section class="section" id="demo">
        <div class="section-header">
            <h2>Демо-ролики</h2>
            <a href="#all">Наверх</a>
        </div>
        <div class="video-grid" id="demo-grid"></div>
        <p class="empty-state" id="demo-empty">Пока нет демо-роликов.</p>
    </section>
</main>

<footer class="footer">
    <p>(c) RiverDub Studio, 2024. <a href="index_admin.html">Все права защищены.</a></p>
</footer>
<script>
    (function () {
        const typeLabels = {
            video: 'Видео',
            demo: 'Демо-ролик'
        };
        const formatDate = (value) => {
            if (!value) return '';
            const date = new Date(value);
            if (Number.isNaN(date.getTime())) return '';
            return date.toLocaleDateString('ru-RU');
        };
        const createCard = (item) => {
            const article = document.createElement('article');
            article.className = 'video-card';
            const link = document.createElement('a');
            link.className = 'video-link';
            link.href = `index_player.html?id=${item.id}`;
            const thumbStyle = item.preview_url
                ? `style="background-image: url('${item.preview_url}'); background-size: cover; background-position: center;"`
                : '';
            link.innerHTML = `
                <div class="thumb" ${thumbStyle}>${typeLabels[item.type] || 'Видео'}</div>
                <div class="card-body">
                    <h3>${item.title}</h3>
                    <p>${typeLabels[item.type] || 'Видео'} • ${formatDate(item.created_at)}</p>
                </div>
            `;
            article.appendChild(link);
            return article;
        };
        const fillSection = (items, gridId, emptyId) => {
            const grid = document.getElementById(gridId);
            const empty = document.getElementById(emptyId);
            grid.innerHTML = '';
            if (!items.length) {
                empty.style.display = 'block';
                return;
            }
            empty.style.display = 'none';
            items.forEach((item) => grid.appendChild(createCard(item)));
        };
        const queryParam = new URLSearchParams(window.location.search).get('q') || '';
        const searchInput = document.querySelector('.search input');
        if (searchInput && queryParam) {
            searchInput.value = queryParam;
        }
        const seasonSelect = document.getElementById('season-select');
        const seasonParam = new URLSearchParams(window.location.search).get('season') || '';
        if (seasonSelect) {
            seasonSelect.value = seasonParam;
        }
        const queryString = queryParam ? `?q=${encodeURIComponent(queryParam)}` : '';
        fetch(`/api/videos${queryString}`)
            .then((res) => res.ok ? res.json() : [])
            .then((videos) => {
                const cleaned = videos.filter((item) => item.type !== 'interview');
                const seasons = Array.from(
                    new Set(
                        cleaned
                            .map((item) => Number(item.season))
                            .filter((value) => Number.isFinite(value) && value > 0)
                    )
                ).sort((a, b) => a - b);

                if (seasonSelect) {
                    const current = seasonSelect.value;
                    seasonSelect.innerHTML = '<option value=\"\">Все сезоны</option>';
                    seasons.forEach((season) => {
                        const option = document.createElement('option');
                        option.value = String(season);
                        option.textContent = `Сезон ${season}`;
                        seasonSelect.appendChild(option);
                    });
                    seasonSelect.value = seasons.includes(Number(current)) ? current : '';
                }

                const applySeasonFilter = (items) => {
                    const seasonValue = seasonSelect && seasonSelect.value ? Number(seasonSelect.value) : null;
                    if (!seasonValue) return items;
                    return items.filter((item) => Number(item.season) === seasonValue);
                };

                const render = () => {
                    const filtered = applySeasonFilter(cleaned);
                    const regular = filtered.filter((item) => item.type !== 'demo');
                    const demo = filtered.filter((item) => item.type === 'demo');
                    fillSection(regular, 'videos-grid', 'videos-empty');
                    fillSection(demo, 'demo-grid', 'demo-empty');
                };

                render();

                if (seasonSelect) {
                    seasonSelect.addEventListener('change', () => {
                        const params = new URLSearchParams(window.location.search);
                        if (seasonSelect.value) {
                            params.set('season', seasonSelect.value);
                        } else {
                            params.delete('season');
                        }
                        const query = params.toString();
                        history.replaceState(null, '', query ? `?${query}` : window.location.pathname);
                        render();
                    });
                }
            });

        const chips = Array.from(document.querySelectorAll('.filter-bar .chip'));
        const chipById = new Map(
            chips.map((chip) => [chip.getAttribute('href')?.replace('#', ''), chip])
        );
        const sections = Array.from(document.querySelectorAll('main .section'))
            .filter((section) => section.id && chipById.has(section.id));
        const setActive = (id) => {
            chips.forEach((chip) => chip.classList.remove('active'));
            const activeChip = chipById.get(id) || chipById.get('all');
            if (activeChip) {
                activeChip.classList.add('active');
            }
        };

        const isNearTop = () => window.scrollY < 200;

        const onScroll = () => {
            if (isNearTop()) {
                setActive('all');
                return;
            }
        };

        if ('IntersectionObserver' in window) {
            const observer = new IntersectionObserver(
                (entries) => {
                    const visible = entries
                        .filter((entry) => entry.isIntersecting)
                        .sort((a, b) => b.intersectionRatio - a.intersectionRatio);
                    if (visible[0]) {
                        setActive(visible[0].target.id);
                    }
                },
                { rootMargin: '-20% 0px -60% 0px', threshold: [0.1, 0.3, 0.6] }
            );
            sections.forEach((section) => observer.observe(section));
            window.addEventListener('scroll', onScroll, { passive: true });
            onScroll();
        } else {
            const legacyScroll = () => {
                if (isNearTop()) {
                    setActive('all');
                    return;
                }
                const current = sections.find((section) => {
                    const rect = section.getBoundingClientRect();
                    return rect.top <= window.innerHeight * 0.4 && rect.bottom > 0;
                });
                if (current) {
                    setActive(current.id);
                }
            };
            window.addEventListener('scroll', onScroll, { passive: true });
            window.addEventListener('scroll', legacyScroll, { passive: true });
            onScroll();
            legacyScroll();
        }

        chips.forEach((chip) => {
            chip.addEventListener('click', (event) => {
                const id = chip.getAttribute('href')?.replace('#', '');
                if (!id) return;
                const target = document.getElementById(id);
                if (target) {
                    event.preventDefault();
                    target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
                setActive(id);
            });
        });
    })();
</script>
<script src="script.js"></script>
</body>
</html>
